# Verible v5.6.0 - Medium-term Plan (3-6 Months)

**Target Release**: v5.6.0  
**Timeline**: 3-6 months from October 2025  
**Focus**: Macro-Aware Context Tracking  
**Goal**: Eliminate heuristic approach, achieve 100% correctness

---

## 🎯 Objective

Replace the current heuristic-based `->` disambiguation with proper macro-aware context tracking that maintains parser state through macro expansion.

**Current State (v5.5.0)**:
- ✅ Heuristic works for 100% of tested cases
- ⚠️ Theoretically imperfect
- ⚠️ May have undiscovered edge cases
- ⚠️ Technical debt

**Target State (v5.6.0)**:
- ✅ Theoretically perfect
- ✅ No edge cases
- ✅ No technical debt
- ✅ Proper macro context preservation

---

## 📋 Implementation Options (from MACRO_CONTEXT_DESIGN.md)

### Option 1: Macro Boundary Markers ⭐ RECOMMENDED

**Concept**: Inject special tokens at macro boundaries to preserve context

**Pros**:
- ✅ Clean, understandable approach
- ✅ Moderate complexity (2-3 weeks)
- ✅ Reversible if issues found
- ✅ Easy to test incrementally

**Cons**:
- ⚠️ Requires lexer, preprocessor, and parser changes
- ⚠️ Need to handle nested macros correctly

**Effort**: 2-3 weeks  
**Risk**: Medium  
**Recommendation**: **START HERE**

### Option 2: Context Stack

**Concept**: Maintain explicit context stack that persists through macro expansion

**Pros**:
- ✅ No token stream modifications
- ✅ Can track arbitrary state

**Cons**:
- ⚠️ Higher complexity (3-4 weeks)
- ⚠️ Need to identify all relevant state
- ⚠️ Harder to debug

**Effort**: 3-4 weeks  
**Risk**: Medium-High  
**Recommendation**: **Fallback if Option 1 fails**

### Option 3: Two-Pass Preprocessing

**Concept**: First pass expands macros with annotations, second pass parses

**Pros**:
- ✅ Complete context information
- ✅ Clean separation

**Cons**:
- ⚠️ Major architectural change (4-6 weeks)
- ⚠️ Performance impact
- ⚠️ High risk

**Effort**: 4-6 weeks  
**Risk**: High  
**Recommendation**: **Only if Options 1 & 2 fail**

---

## 🗓️ Detailed Timeline (Option 1: Macro Boundary Markers)

### Month 1: Design and Proof-of-Concept

#### Week 1-2: Design Phase
- [x] Review MACRO_CONTEXT_DESIGN.md ✅ (Complete)
- [ ] Create detailed technical spec
- [ ] Design token injection mechanism
- [ ] Design context preservation logic
- [ ] Identify all touch points in codebase

**Deliverables**:
- Technical specification document
- API design for marker injection
- Test plan with success criteria

#### Week 3-4: Proof-of-Concept
- [ ] Create feature branch `feature/macro-boundary-markers`
- [ ] Add `TK_MACRO_BOUNDARY_START` and `TK_MACRO_BOUNDARY_END` tokens to lexer
- [ ] Implement basic marker injection in `VerilogPreprocess::HandleMacroIdentifier()`
- [ ] Create minimal test cases

**Deliverables**:
- Working prototype with simple macros
- 5-10 passing unit tests
- Performance baseline

**Success Criteria**:
- Simple macro expansions preserve context
- No performance degradation >5%
- All existing tests still pass

### Month 2: Full Implementation

#### Week 5-6: Core Implementation
- [ ] Implement full marker injection logic
- [ ] Add macro depth tracking to `LexicalContext`
- [ ] Implement context save/restore on boundaries
- [ ] Handle nested macros correctly

**Deliverables**:
- Complete marker injection
- Context preservation working
- Nested macro support

#### Week 7-8: Integration and Refinement
- [ ] Update `ExpectingStatement()` to use macro context
- [ ] Remove heuristic fallback code
- [ ] Add comprehensive logging
- [ ] Performance optimization

**Deliverables**:
- Heuristic code removed
- All functionality on new system
- Performance optimized

**Success Criteria**:
- OpenTitan corpus: 100% success
- Ibex corpus: 95%+ success
- No performance degradation

### Month 3: Testing and Validation

#### Week 9-10: Comprehensive Testing
- [ ] Test against OpenTitan (full corpus)
- [ ] Test against Ibex RISC-V
- [ ] Test against PULPino
- [ ] Test against synthetic edge cases
- [ ] Stress testing with deeply nested macros

**Deliverables**:
- Test report for each corpus
- Edge case documentation
- Performance benchmarks

#### Week 11-12: Bug Fixes and Refinement
- [ ] Fix all identified issues
- [ ] Add regression tests for each bug
- [ ] Final performance tuning
- [ ] Code review and cleanup

**Deliverables**:
- Zero known bugs
- Comprehensive test coverage
- Clean, maintainable code

**Success Criteria**:
- OpenTitan: 100% success
- Ibex: 97%+ success
- PULPino: 97%+ success
- All regression tests pass
- Performance: < 5% degradation

### Month 4-6: Documentation, Review, Release (If Needed)

#### Month 4: Documentation
- [ ] Update all user guides
- [ ] Write migration guide
- [ ] Document new architecture
- [ ] Update MACRO_CONTEXT_DESIGN.md with implementation details
- [ ] Create release notes

**Deliverables**:
- Updated documentation (4+ files)
- Migration guide for users
- Architecture documentation

#### Month 5: Code Review and Upstream
- [ ] Internal code review
- [ ] Address review feedback
- [ ] Prepare for upstream contribution
- [ ] Create pull request to chipsalliance/verible

**Deliverables**:
- Code review complete
- All feedback addressed
- PR submitted upstream

#### Month 6: Release and Monitoring
- [ ] Tag v5.6.0
- [ ] Deploy binaries
- [ ] Monitor production usage
- [ ] Address any post-release issues

**Deliverables**:
- v5.6.0 released
- Binaries deployed
- Monitoring active
- Zero critical issues

---

## 🧪 Testing Strategy

### Unit Tests (20+ new tests)
```cpp
TEST(MacroBoundaryTest, SimpleMacroExpansion) {
  // Test basic marker injection
}

TEST(MacroBoundaryTest, NestedMacros) {
  // Test macro-in-macro handling
}

TEST(MacroBoundaryTest, ContextPreservation) {
  // Test context saves/restores correctly
}

TEST(MacroBoundaryTest, EventTriggerAfterMacro) {
  // Test original use case still works
}

TEST(MacroBoundaryTest, LogicalImplicationInExpression) {
  // Test expressions still parse correctly
}

// ... 15+ more tests
```

### Integration Tests
- OpenTitan corpus (3911 files)
- Ibex corpus (637 files)
- PULPino corpus (44 files)
- Synthetic edge cases (100+ cases)

### Performance Tests
- Parse timing: < 5% degradation
- Memory usage: < 10% increase
- Macro expansion: No visible slowdown

### Regression Tests
- All v5.5.0 tests must pass
- No regressions in existing functionality
- Baseline comparison with v5.5.0

---

## 📊 Success Criteria

### Correctness
- ✅ OpenTitan: 100% parsing success (currently 100%)
- ✅ Ibex: 97%+ success (currently 97%)
- ✅ PULPino: 97%+ success (currently 97%)
- ✅ Zero known edge cases
- ✅ Theoretical correctness proven

### Performance
- ✅ Parse timing: < 5% degradation from v5.5.0
- ✅ Memory usage: < 10% increase from v5.5.0
- ✅ No user-visible slowdown

### Code Quality
- ✅ All new code reviewed
- ✅ Comprehensive test coverage (>90%)
- ✅ Clean, maintainable implementation
- ✅ Well-documented architecture

### User Impact
- ✅ Zero breaking changes
- ✅ Transparent to end users
- ✅ Improved reliability
- ✅ Clear migration path (if needed)

---

## 🚧 Risk Mitigation

### Risk 1: Implementation More Complex Than Expected
**Likelihood**: Medium  
**Impact**: High (delays release)

**Mitigation**:
- Start with Option 1 (simplest)
- Have Option 2 as fallback
- Monthly checkpoints to assess progress
- Can split across multiple releases if needed

### Risk 2: Performance Degradation
**Likelihood**: Low  
**Impact**: Medium (user complaints)

**Mitigation**:
- Continuous performance monitoring
- Benchmark at each milestone
- Optimize hot paths early
- Have rollback plan

### Risk 3: Breaks Existing Functionality
**Likelihood**: Low  
**Impact**: High (production issues)

**Mitigation**:
- Comprehensive regression testing
- Feature flag for rollback
- Phased rollout (internal → external)
- Keep v5.5.0 available

### Risk 4: Scope Creep
**Likelihood**: Medium  
**Impact**: Medium (delays)

**Mitigation**:
- Strict adherence to plan
- Monthly scope reviews
- MVP approach: working > perfect
- Can defer optimizations to v5.7.0

---

## 💰 Resource Requirements

### Development Time
- **Month 1**: 40-60 hours (design + PoC)
- **Month 2**: 60-80 hours (implementation)
- **Month 3**: 40-60 hours (testing)
- **Month 4-6**: 20-40 hours (docs + release)
- **Total**: 160-240 hours over 6 months

### Testing Time
- Corpus testing: 10-20 hours
- Performance testing: 5-10 hours
- Edge case discovery: 10-20 hours
- **Total**: 25-50 hours

### Documentation Time
- Technical docs: 10-15 hours
- User guides: 5-10 hours
- Migration guide: 3-5 hours
- **Total**: 18-30 hours

### **Grand Total**: 203-320 hours (5-8 weeks FTE)

---

## 📅 Milestones and Checkpoints

### Milestone 1: Month 1 End
**Target**: Proof-of-concept working

**Checkpoint Questions**:
- Does PoC work for simple cases?
- Is performance acceptable?
- Are all existing tests passing?

**Go/No-Go Decision**: If PoC fails, pivot to Option 2

### Milestone 2: Month 2 End
**Target**: Full implementation complete

**Checkpoint Questions**:
- Does it handle all OpenTitan patterns?
- Is performance within budget?
- Are nested macros working?

**Go/No-Go Decision**: If implementation blocked, extend timeline or pivot

### Milestone 3: Month 3 End
**Target**: Testing complete, zero known bugs

**Checkpoint Questions**:
- Do all corpora pass at target rates?
- Are there any edge cases?
- Is performance acceptable?

**Go/No-Go Decision**: Ready for documentation and release

### Final Milestone: Month 6 End
**Target**: v5.6.0 released and stable

**Success Metrics**:
- Zero critical post-release issues
- User feedback positive
- Performance goals met
- Upstream PR submitted

---

## 🔄 Alternative Path: Enhanced Heuristic

If macro boundary markers prove too complex, we can enhance the current heuristic:

### Enhanced Heuristic Features
- Multi-token lookahead (3-5 previous tokens)
- Pattern matching for common constructs
- Context history tracking
- Probabilistic disambiguation

**Effort**: 1-2 weeks  
**Risk**: Low  
**Correctness**: 99.5%+ (not 100%)

**When to Use**:
- PoC fails or too complex
- Performance unacceptable
- Timeline at risk
- Good enough for production needs

---

## 📖 Dependencies

### External Dependencies
- None (all changes internal to Verible)

### Internal Dependencies
- v5.5.0 must be stable in production
- Monitoring system must show no issues
- User feedback must be positive

### Upstream Dependencies
- Track chipsalliance/verible for conflicts
- Coordinate with upstream on design
- Plan for eventual contribution

---

## 🎓 Learning and Knowledge Transfer

### Documentation for Team
- Architecture overview document
- Implementation walkthrough
- Debug guide for macro issues
- Performance optimization guide

### Knowledge Sharing
- Internal presentation on design
- Blog post on approach (optional)
- Conference talk (optional)
- Contribution to SystemVerilog community

---

## 📈 Success Metrics (Post-Release)

### Week 1 After Release
- ✅ Zero critical bugs reported
- ✅ Performance within 5% of v5.5.0
- ✅ User feedback: positive or neutral

### Month 1 After Release
- ✅ < 2 user-reported issues
- ✅ OpenTitan: 100% success maintained
- ✅ No performance complaints
- ✅ Monitoring shows stable operation

### Month 3 After Release
- ✅ Zero open bugs
- ✅ Positive user testimonials
- ✅ Upstream PR accepted (if submitted)
- ✅ Adoption by other projects

---

## 🚀 Next Steps (Immediate)

### This Week
1. ✅ Complete v5.5.0 deployment and validation
2. [ ] Review MACRO_CONTEXT_DESIGN.md in detail
3. [ ] Create technical specification document
4. [ ] Set up feature branch
5. [ ] Schedule Month 1 kickoff

### Next Week
1. [ ] Begin PoC implementation
2. [ ] Add TK_MACRO_BOUNDARY tokens
3. [ ] Write first 5 unit tests
4. [ ] Baseline performance measurements

### This Month (Month 1)
1. [ ] Complete PoC
2. [ ] Validate approach
3. [ ] Make go/no-go decision
4. [ ] Plan Month 2 if proceeding

---

## 🎯 Conclusion

The medium-term plan for v5.6.0 provides a clear path to eliminate the heuristic approach and achieve 100% theoretical correctness for `->` disambiguation. With proper macro-aware context tracking, Verible will have a robust, maintainable solution for macro expansion context preservation.

**Timeline**: 3-6 months  
**Effort**: 203-320 hours  
**Risk**: Medium (with mitigation)  
**Impact**: High (eliminates technical debt)  
**Recommendation**: Proceed with Option 1 (Macro Boundary Markers)

**Status**: Ready to begin after v5.5.0 stabilization

---

**Document Version**: 1.0  
**Date**: October 19, 2025  
**Author**: Development Team  
**Review Status**: Ready for approval

